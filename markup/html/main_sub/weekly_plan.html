<div class="main-weekly weekly" id="weekly">
  <div class="weekly-grid">
    <div class="weekly-header">
      <div class="weekly-title">
        <h3>11월 5주차</h3>
        <p>주간 영업 계획</p>
      </div>
      <ul class="person-list">
        <li>
          <span class="badge-green">권</span
          ><span class="name">권혁진 <small>수석</small></span>
        </li>
        <li>
          <span class="badge-purple">염</span
          ><span class="name">염승호 <small>수석</small></span>
        </li>
        <li>
          <span class="badge-teal">김</span
          ><span class="name">김지영 <small>수석</small></span>
        </li>
      </ul>
    </div>
    <div class="schedule">
      <div class="day-card" data-date="2025-11-24">
        <div class="day-title">24일 <span>(월)</span></div>
        <ul class="day-list">
          <li data-start="09:00" data-end="10:00">
            <a href="#" class="schedule-item" data-id="1">
              한라대학교 (강의커리큐럼 초안 작성 )
              <span class="badge-green">권</span>
              <span class="badge-purple">염</span>
            </a>
          </li>
          <li data-start="10:00" data-end="11:00">
            브로슈어 우편물 발송 계획 ( 수도권, 선별 외 )
            <span class="badge-green">권</span>
            <span class="badge-teal">김</span>
          </li>
          <li data-start="13:00" data-end="14:00">
            교육기관 마케팅 보고서 작성
            <span class="badge-purple">염</span>
          </li>
          <li data-start="14:00" data-end="15:00">
            교육기관 EG-BIM 라이선스 배포 현황 보고서 작성
            <span class="badge-teal">김</span>
          </li>
          <li data-start="15:00" data-end="18:00">
            대림대학교 현물 기부금 처리 서류 작성
            <span class="badge-teal">김</span>
          </li>
        </ul>
      </div>
      <div class="day-card" data-date="2025-11-25">
        <div class="day-title">25일 <span>(화)</span></div>
        <ul class="day-list">
          <li data-start="10:20" data-end="12:00">
            10:30 ~ 12:00 삼안 CM현장 : 해안.방산 ( 오미) 공공하수처리시설
            신동훈 부사장님 (강원특별자치도 양구군 방산면 평화로5107번길 14)
            <span class="badge-green">권</span>
            <span class="badge-purple">염</span>
          </li>
          <li data-start="13:00" data-end="15:00">
            13:00 ~ 15:00 상지대, 지반공학회장 미팅
            <span class="badge-green">권</span>
            <span class="badge-purple">염</span>
          </li>
        </ul>
      </div>
      <div class="day-card" data-date="2025-11-26">
        <div class="day-title">26일 <span>(수)</span></div>
        <ul class="day-list">
          <li data-start="10:30" data-end="14:00">
            10:30 ~ 14:00 한국종합기술 ( 총괄본부장 - 김원식전무님, 복진훈수석님
            동행 )
            <span class="badge-green">권</span>
            <span class="badge-purple">염</span>
          </li>
          <li data-start="15:00" data-end="15:30">
            15:00 ~ 15:30 삼안 대표이사님 면담 / 삼안 CM현장 6개소 방문결과 보고
            외
            <span class="badge-green">권</span>
          </li>
          <li data-start="16:00" data-end="18:00">
            16:00 ~ 18:00 의왕도시공사 MOU체결
            <span class="badge-green">권</span>
            <span class="badge-purple">염</span>
          </li>
          <li>
            삼안 ( 서울대 교육 지원 )
            <span class="badge-purple">염</span>
          </li>
        </ul>
      </div>
      <div class="day-card" data-date="2025-11-27">
        <div class="day-title">27일 <span>(목)</span></div>
        <ul class="day-list">
          <li data-start="12:00" data-end="17:00">
            15:00 ~ 17:00 사장님 영업보고 ( PM 활용 ) 교육기관, 가격정책,
            기능개선, 단가프로그램 등
            <span class="badge-green">권</span>
            <span class="badge-purple">염</span>
            <span class="badge-teal">김</span>
          </li>
          <li>
            석식 (팀 + 이웃집 )
            <span class="badge-green">권</span>
            <span class="badge-purple">염</span>
            <span class="badge-teal">김</span>
          </li>
        </ul>
      </div>
      <div class="day-card" data-date="2025-11-28">
        <div class="day-title">28일 <span>(금)</span></div>
        <ul class="day-list"></ul>
      </div>
    </div>
  </div>
</div>

<script src="./assets/js/schedule-manager.min.js"></script>
<script>
  // 사용
  const scheduleManager = new ScheduleManager();
  scheduleManager.initialize();

  let isCalendarLoaded = false;
  // 모달 열기
  function openModal() {
    const existingModal = document.getElementById("scheduleModal");

    // 기존 모달이 있으면 제거
    if (existingModal) {
      existingModal.remove();
    }

    // 항상 새로 로드 (데이터 최신화)
    fetchScheduleDetail();
  }

  // 모달 닫기
  function closeModal() {
    const modal = document.getElementById("scheduleModal");
    modal.remove();
  }

  // AJAX로 calendar.html 페이지 가져오기
  function fetchScheduleDetail() {
    const weekly = document.getElementById("weekly");

    fetch(`/main_sub/calendar.html`)
      .then((response) => response.text())
      .then((html) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const content = doc.body.childNodes;

        content.forEach((node) => {
          weekly.append(node.cloneNode(true));
        });

        // 🔑 핵심: script는 한 번만 로드
        if (!isCalendarLoaded) {
          const scripts = doc.querySelectorAll("script");
          scripts.forEach((script) => {
            const newScript = document.createElement("script");
            if (script.src) {
              newScript.src = script.src;
            } else {
              newScript.textContent = script.textContent;
            }
            document.body.appendChild(newScript);
          });
          isCalendarLoaded = true;
        } else {
          // 두 번째부터는 직접 스크립트 실행
          const scripts = doc.querySelectorAll("script");
          scripts.forEach((script) => {
            if (!script.src) {
              // inline 스크립트만 실행 (함수 정의 제외하고 실행 부분만)
              try {
                eval(script.textContent);
              } catch (e) {
                console.error("Script execution error:", e);
              }
            }
          });
        }
      });
  }
  // 일정 항목 클릭 이벤트
  document.addEventListener("DOMContentLoaded", function () {
    const scheduleItems = document.querySelectorAll(".schedule-item");

    scheduleItems.forEach((item) => {
      item.addEventListener("click", function (e) {
        e.preventDefault();
        const scheduleId = this.getAttribute("data-id");
        openModal(scheduleId);
      });
    });
  });
</script>
