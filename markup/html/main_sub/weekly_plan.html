<div class="main-weekly weekly" id="weekly">
  <div class="weekly-grid">
    <div class="weekly-header">
      <div class="weekly-title">
        <h3 id="weekTitle">11ì›” 5ì£¼ì°¨</h3>
        <p>ì£¼ê°„ ì˜ì—… ê³„íš</p>
        <div class="week-navigation">
          <button class="week-nav-btn" id="prevWeek" title="ì´ì „ ì£¼">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </button>
          <button class="week-nav-btn" id="nextWeek" title="ë‹¤ìŒ ì£¼">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M9 18l6-6-6-6" />
            </svg>
          </button>
        </div>
      </div>

      <ul class="person-list">
        <li>
          <span class="badge-green">ê¶Œ</span
          ><span class="name">ê¶Œí˜ì§„ <small>ìˆ˜ì„</small></span>
        </li>
        <li>
          <span class="badge-purple">ì—¼</span
          ><span class="name">ì—¼ìŠ¹í˜¸ <small>ìˆ˜ì„</small></span>
        </li>
        <li>
          <span class="badge-teal">ê¹€</span
          ><span class="name">ê¹€ì§€ì˜ <small>ìˆ˜ì„</small></span>
        </li>
      </ul>
    </div>
    <div class="schedule" id="scheduleContainer"></div>
  </div>
  <div class="main-issue">
    <div class="issue-header">
      <h3>ì›”ê°„ ì£¼ìš” ì´ìŠˆ</h3>
    </div>
    <div class="issue">
      <ul class="issue-list">
        <li>ì£¼ìš” ì´ìŠˆ A</li>
        <li>ì£¼ìš” ì´ìŠˆ B</li>
      </ul>
    </div>
  </div>
</div>
<script src="./assets/js/schedule-manager.min.js"></script>
<script src="./assets/js/events-data.min.js"></script>
<script>
  // íƒœê·¸ ë§¤í•‘
  const tagMapping = {
    ê¶Œ: "green",
    ì—¼: "purple",
    ê¹€: "teal",
  };

  // í˜„ì¬ ì£¼ì°¨ ìƒíƒœ
  let currentWeekStart = new Date(2025, 10, 24); // 11ì›” 24ì¼ (ì›”ìš”ì¼)

  // ì£¼ì°¨ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
  function updateWeekTitle() {
    const weekStart = new Date(currentWeekStart);
    const month = weekStart.getMonth() + 1;
    const startDate = weekStart.getDate();

    // í•´ë‹¹ ì›”ì˜ ëª‡ ë²ˆì§¸ ì£¼ì¸ì§€ ê³„ì‚°
    const firstDayOfMonth = new Date(
      weekStart.getFullYear(),
      weekStart.getMonth(),
      1
    );
    const weekOfMonth = Math.ceil((startDate + firstDayOfMonth.getDay()) / 7);

    document.getElementById("weekTitle").textContent =
      `${month}ì›” ${weekOfMonth}ì£¼ì°¨`;
  }

  // ìš”ì¼ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
  function getDayName(dayIndex) {
    const days = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    return days[dayIndex];
  }

  // ì£¼ê°„ ì¼ì • ë Œë”ë§
  function renderWeeklySchedule() {
    const container = document.getElementById("scheduleContainer");
    container.innerHTML = "";

    // ì›”ìš”ì¼ë¶€í„° ê¸ˆìš”ì¼ê¹Œì§€ (5ì¼)
    for (let i = 0; i < 5; i++) {
      const currentDate = new Date(currentWeekStart);
      currentDate.setDate(currentWeekStart.getDate() + i);

      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, "0");
      const day = String(currentDate.getDate()).padStart(2, "0");
      const dateKey = `${year}-${month}-${day}`;

      const dayOfWeek = getDayName(currentDate.getDay());
      const dayEvents = eventsData[dateKey] || [];

      // ì¹´ë“œ ìƒì„±
      const dayCard = document.createElement("div");
      dayCard.className = "day-card";
      dayCard.dataset.date = dateKey;

      let dayHTML = `
          <div class="day-title">${day}ì¼ <span>(${dayOfWeek})</span></div>
          <ul class="day-list">
        `;

      if (dayEvents.length === 0) {
        // dayHTML +=
        //   '<li style="color: #9ca3af; font-size: 12px; padding: 8px;">ì¼ì • ì—†ìŒ</li>';
      } else {
        dayEvents.forEach((event) => {
          const tagsHTML = event.tags
            .map(
              (tag) => `<span class="badge-${tagMapping[tag]}">${tag}</span>`
            )
            .join("");

          dayHTML += `
              <li>
                <a href="#" class="schedule-item">
                  ${event.title}
                  ${tagsHTML}
                </a>
              </li>
            `;
        });
      }

      dayHTML += "</ul>";
      dayCard.innerHTML = dayHTML;
      container.appendChild(dayCard);
    }

    updateWeekTitle();
  }

  // ì´ì „ ì£¼ë¡œ ì´ë™
  document.getElementById("prevWeek").addEventListener("click", () => {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderWeeklySchedule();
  });

  // ë‹¤ìŒ ì£¼ë¡œ ì´ë™
  document.getElementById("nextWeek").addEventListener("click", () => {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderWeeklySchedule();
  });

  // ì´ˆê¸° ë Œë”ë§
  renderWeeklySchedule();
</script>

<script>
  let isCalendarLoaded = false;
  // ëª¨ë‹¬ ì—´ê¸°
  function openModal() {
    const existingModal = document.getElementById("scheduleModal");

    // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
    if (existingModal) {
      existingModal.remove();
    }

    // í•­ìƒ ìƒˆë¡œ ë¡œë“œ (ë°ì´í„° ìµœì‹ í™”)
    fetchScheduleDetail();
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  function closeModal() {
    const modal = document.getElementById("scheduleModal");
    modal.classList.add("closing");
    setTimeout(() => {
      modal.remove();
    }, 400);
  }

  // AJAXë¡œ calendar.html í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
  function fetchScheduleDetail() {
    const weekly = document.getElementById("weekly");

    fetch(`./main_sub/calendar.html`)
      .then((response) => response.text())
      .then((html) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const content = doc.body.childNodes;

        content.forEach((node) => {
          weekly.append(node.cloneNode(true));
        });

        // ğŸ”‘ í•µì‹¬: scriptëŠ” í•œ ë²ˆë§Œ ë¡œë“œ
        if (!isCalendarLoaded) {
          const scripts = doc.querySelectorAll("script");
          scripts.forEach((script) => {
            const newScript = document.createElement("script");
            if (script.src) {
              newScript.src = script.src;
            } else {
              newScript.textContent = script.textContent;
            }
            document.body.appendChild(newScript);
          });
          isCalendarLoaded = true;
        } else {
          // ë‘ ë²ˆì§¸ë¶€í„°ëŠ” ì§ì ‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          const scripts = doc.querySelectorAll("script");
          scripts.forEach((script) => {
            if (!script.src) {
              // inline ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰ (í•¨ìˆ˜ ì •ì˜ ì œì™¸í•˜ê³  ì‹¤í–‰ ë¶€ë¶„ë§Œ)
              try {
                eval(script.textContent);
              } catch (e) {
                console.error("Script execution error:", e);
              }
            }
          });
        }
      });
  }
  // ì¼ì • í•­ëª© í´ë¦­ ì´ë²¤íŠ¸
  document.addEventListener("DOMContentLoaded", function () {
    const scheduleItems = document.querySelectorAll(".schedule-item");

    scheduleItems.forEach((item) => {
      item.addEventListener("click", function (e) {
        e.preventDefault();
        const scheduleId = this.getAttribute("data-id");
        openModal(scheduleId);
      });
    });
  });
</script>
