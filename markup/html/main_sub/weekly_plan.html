<div class="main-weekly weekly" id="weekly">
  <div class="weekly-grid">
    <div class="weekly-header">
      <div class="weekly-title">
        <p>ì£¼ê°„ ì˜ì—… ê³„íš</p>
        <div class="week-navigation">
          <button class="week-nav-btn" id="prevWeek" title="ì´ì „ ì£¼">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#424242"
              stroke-width="2"
            >
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </button>
          <h3 id="weekTitle">11ì›” 5ì£¼ì°¨</h3>
          <button class="week-nav-btn" id="nextWeek" title="ë‹¤ìŒ ì£¼">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#424242"
              stroke-width="2"
            >
              <path d="M9 18l6-6-6-6" />
            </svg>
          </button>
        </div>
      </div>

      <ul class="person-list">
        <li>
          <span class="badge-green">ê¶Œ</span
          ><span class="name">ê¶Œí˜ì§„ <small>ìˆ˜ì„</small></span>
        </li>
        <li>
          <span class="badge-purple">ì—¼</span
          ><span class="name">ì—¼ìŠ¹í˜¸ <small>ìˆ˜ì„</small></span>
        </li>
        <li>
          <span class="badge-teal">ê¹€</span
          ><span class="name">ê¹€ì§€ì˜ <small>ìˆ˜ì„</small></span>
        </li>
      </ul>
    </div>
    <div class="schedule" id="scheduleContainer"></div>
  </div>
  <div class="main-issue">
    <div class="issue-header">
      <h3>ì£¼ìš” ì´ìŠˆ ì‚¬í•­</h3>
    </div>
    <div class="issue">
      <ul class="issue-list">
        <li>ì£¼ìš” ì´ìŠˆ A</li>
        <li>ì£¼ìš” ì´ìŠˆ B</li>
      </ul>
    </div>
  </div>
</div>
<script src="./assets/js/schedule-manager.min.js"></script>
<script src="./assets/js/events-data.min.js"></script>
<script>
  // íƒœê·¸ ë§¤í•‘
  const tagMapping = {
    ê¶Œ: "green",
    ì—¼: "purple",
    ê¹€: "teal",
  };

  // í˜„ì¬ ë‚ ì§œì—ì„œ ì´ë²ˆ ì£¼ ì›”ìš”ì¼ êµ¬í•˜ê¸°
  function getThisMonday() {
    const today = new Date();
    const day = today.getDay(); // 0(ì¼) ~ 6(í† )
    const diff = day === 0 ? -6 : 1 - day; // ì¼ìš”ì¼ì´ë©´ -6, ì•„ë‹ˆë©´ 1-day

    const monday = new Date(today);
    monday.setDate(today.getDate() + diff);
    monday.setHours(0, 0, 0, 0); // ì‹œê°„ ì´ˆê¸°í™”

    return monday;
  }
  // í˜„ì¬ ì£¼ì°¨ ìƒíƒœ
  let currentWeekStart = getThisMonday();

  // ì£¼ì°¨ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
  function updateWeekTitle() {
    const weekStart = new Date(currentWeekStart);
    const month = weekStart.getMonth() + 1;
    const startDate = weekStart.getDate();

    // í•´ë‹¹ ì›”ì˜ ëª‡ ë²ˆì§¸ ì£¼ì¸ì§€ ê³„ì‚°
    const firstDayOfMonth = new Date(
      weekStart.getFullYear(),
      weekStart.getMonth(),
      1
    );
    const weekOfMonth = Math.ceil((startDate + firstDayOfMonth.getDay()) / 7);

    document.getElementById("weekTitle").textContent =
      `${month}ì›” ${weekOfMonth}ì£¼ì°¨`;
  }

  // ìš”ì¼ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
  function getDayName(dayIndex) {
    const days = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    return days[dayIndex];
  }

  // ì‹œê°„ ë¬¸ìì—´ íŒŒì‹± í•¨ìˆ˜
  function parseTimeString(timeStr) {
    if (!timeStr || timeStr.trim() === "") {
      return { start: "", end: "" };
    }

    const match = timeStr.match(/(\d{1,2}:\d{2})\s*~\s*(\d{1,2}:\d{2})?/);

    if (match) {
      return {
        start: match[1] || "",
        end: match[2] || "",
      };
    }

    return { start: "", end: "" };
  }

  // ì£¼ê°„ ì¼ì • ë Œë”ë§ (period í¬í•¨)
  function renderWeeklySchedule() {
    const container = document.getElementById("scheduleContainer");
    container.innerHTML = "";

    for (let i = 0; i < 5; i++) {
      const currentDate = new Date(currentWeekStart);
      currentDate.setDate(currentWeekStart.getDate() + i);

      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, "0");
      const day = String(currentDate.getDate()).padStart(2, "0");
      const dateKey = `${year}-${month}-${day}`;

      const dayOfWeek = getDayName(currentDate.getDay());
      const dayEvents = eventsData[dateKey] || [];

      const dayCard = document.createElement("div");
      dayCard.className = "day-card";
      dayCard.dataset.date = dateKey;

      let dayHTML = `
      <div class="day-title">${day}ì¼ <span>(${dayOfWeek})</span></div>
      <ul class="day-list">
    `;

      if (dayEvents.length > 0) {
        dayEvents.forEach((event) => {
          const tagsHTML = event.tags
            .map(
              (tag) => `<span class="badge-${tagMapping[tag]}">${tag}</span>`
            )
            .join("");

          // time í•„ë“œì—ì„œ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ì¶”ì¶œ
          const { start, end } = parseTimeString(event.time);

          // period ìë™ íŒë‹¨ (ì—†ìœ¼ë©´)
          let period = event.period;
          if (!period) {
            if (!start || !end) {
              period = "ì¢…ì¼";
            } else {
              const hour = parseInt(start.split(":")[0]);
              period = hour < 12 ? "ì˜¤ì „" : "ì˜¤í›„";
            }
          }

          // data ì†ì„±: period ìš°ì„ , ì—†ìœ¼ë©´ ì •í™•í•œ ì‹œê°„
          const dataAttrs = period
            ? `data-period="${period}"`
            : start && end
              ? `data-start="${start}" data-end="${end}"`
              : "";

          dayHTML += `
          <li ${dataAttrs}>
            <a href="#" class="schedule-item">
              ${event.title}
              ${tagsHTML}
            </a>
          </li>
        `;
        });
      }

      dayHTML += "</ul>";
      dayCard.innerHTML = dayHTML;
      container.appendChild(dayCard);
    }

    updateWeekTitle();
  }

  // ì´ì „ ì£¼ë¡œ ì´ë™
  document.getElementById("prevWeek").addEventListener("click", () => {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderWeeklySchedule();
  });

  // ë‹¤ìŒ ì£¼ë¡œ ì´ë™
  document.getElementById("nextWeek").addEventListener("click", () => {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderWeeklySchedule();
  });

  // ì´ˆê¸° ë Œë”ë§
  renderWeeklySchedule();
</script>

<script>
  let isCalendarLoaded = false;
  // ëª¨ë‹¬ ì—´ê¸°
  function openModal() {
    const existingModal = document.getElementById("scheduleModal");

    // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
    if (existingModal) {
      existingModal.remove();
    }

    // í•­ìƒ ìƒˆë¡œ ë¡œë“œ (ë°ì´í„° ìµœì‹ í™”)
    fetchScheduleDetail();
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  function closeModal() {
    const modal = document.getElementById("scheduleModal");
    modal.classList.add("closing");
    isCalendarLoaded = false;
    setTimeout(() => {
      modal.remove();
    }, 400);
  }

  // AJAXë¡œ calendar.html í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
  function fetchScheduleDetail() {
    const weekly = document.getElementById("weekly");

    fetch(`./main_sub/calendar.html`)
      .then((response) => response.text())
      .then((html) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const content = doc.body.childNodes;

        content.forEach((node) => {
          weekly.append(node.cloneNode(true));
        });

        // ğŸ”‘ í•µì‹¬: scriptëŠ” í•œ ë²ˆë§Œ ë¡œë“œ
        if (!isCalendarLoaded) {
          const scripts = doc.querySelectorAll("script");
          scripts.forEach((script) => {
            const newScript = document.createElement("script");
            if (script.src) {
              newScript.src = script.src;
            } else {
              newScript.textContent = script.textContent;
            }
            document.body.appendChild(newScript);
          });
          isCalendarLoaded = true;
        } else {
          // ë‘ ë²ˆì§¸ë¶€í„°ëŠ” ì§ì ‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          const scripts = doc.querySelectorAll("script");
          scripts.forEach((script) => {
            if (!script.src) {
              // inline ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰ (í•¨ìˆ˜ ì •ì˜ ì œì™¸í•˜ê³  ì‹¤í–‰ ë¶€ë¶„ë§Œ)
              try {
                eval(script.textContent);
              } catch (e) {
                console.error("Script execution error:", e);
              }
            }
          });
        }
      });
  }
  // ì¼ì • í•­ëª© í´ë¦­ ì´ë²¤íŠ¸
  document.addEventListener("DOMContentLoaded", function () {
    const scheduleItems = document.querySelectorAll(".schedule-item");

    scheduleItems.forEach((item) => {
      item.addEventListener("click", function (e) {
        e.preventDefault();
        const scheduleId = this.getAttribute("data-id");
        openModal(scheduleId);
      });
    });
  });

  const scheduleManager = new ScheduleManager();
  scheduleManager.initialize();
</script>
