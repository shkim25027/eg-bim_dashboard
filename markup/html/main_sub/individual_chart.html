<section class="card individual">
  <div class="chart-wrap">
    <div class="card-header">
      <h3>연간 개인별 판매 실적<span class="tail"></span></h3>
      <div class="legend">
        <span>
          <span class="legend-dot line-area01"></span>
          권혁진 수석
        </span>
        <span>
          <span class="legend-dot line-area02"></span>
          염승호 수석
        </span>
        <span class="unit">(단위:copy) </span>
      </div>
    </div>
    <div class="chart-body">
      <div class="badge-box">
        <span class="badge-individual01">목표 200</span>
        <span class="badge-individual02">목표 300</span>
      </div>
      <canvas id="individual_chart"></canvas>
    </div>
  </div>
  <div class="card-body">
    <div class="person-box">
      <div class="person-name"><span>권혁진</span> <small>수석</small></div>
      <div class="stat-row individual01">
        <div class="label-box">
          <span class="label">누적 판매수</span>
          <div class="change-down">전월대비 <em>27</em></div>
        </div>
        <div>
          <span class="big-num">162</span><span class="unit">copy</span>
        </div>
      </div>
      <div class="stat-row">
        <div class="label-box">
          <span class="label">목표 달성률</span>
          <div class="change-up">전월대비 <em>15p</em></div>
        </div>
        <div><span class="big-num">81</span><span class="unit">%</span></div>
      </div>
    </div>
    <div class="person-box">
      <div class="person-name">
        <span>염승호</span>
        <small>수석</small>
      </div>
      <div class="stat-row individual02">
        <div class="label-box">
          <span class="label">누적 판매수</span>
          <div class="change-up">전월대비 <em>105</em></div>
        </div>
        <div>
          <span class="big-num">508</span><span class="unit copy">copy</span>
        </div>
      </div>
      <div class="stat-row">
        <div class="label-box">
          <span class="label">목표 달성률</span>
          <div class="change-up">전월대비 <em>63p</em></div>
        </div>
        <div><span class="big-num">169.3</span><span class="unit">%</span></div>
      </div>
    </div>
  </div>
</section>
<script>
  (() => {
    const labels12 = Array.from({ length: 12 }, (_, i) => String(i + 1));

    let individualInstance = null; // 차트 생성 함수
    function createIndividualChart() {
      const individual_chart = document.getElementById("individual_chart"); // 기존 차트가 있으면 제거

      if (individualInstance) {
        individualInstance.destroy();
      } // 라인 + 영역

      individualInstance = new Chart(individual_chart, {
        type: "line",
        data: {
          labels: labels12,
          datasets: [
            {
              label: "권혁진 수석",
              data: [0, 0, 0, 0, 0, 0, 0, 1, 74, 57, 30, null],
              fill: true,
              backgroundColor: (ctx) => {
                const a = ctx.chart.chartArea;
                return !a
                  ? cssVar("--bg-chart-area01")
                  : safeGrad(
                      ctx.chart.ctx,
                      a,
                      [
                        { stop: 0, color: cssVar("--bg-chart-area01") },
                        { stop: 1, color: "rgba(255, 255, 255, 0.3)" },
                      ],
                      true
                    );
              },
              borderColor: cssVar("--bg-chart-linearea01"),
              borderWidth: 1,
              pointRadius: 5,
              tension: 0,
            },
            {
              label: "염승호 수석 ",
              data: [0, 0, 0, 0, 0, 0, 0, 82, 153, 84, 189, null],
              fill: true,
              backgroundColor: (ctx) => {
                const a = ctx.chart.chartArea;
                return !a
                  ? cssVar("--bg-chart-area02")
                  : safeGrad(
                      ctx.chart.ctx,
                      a,
                      [
                        { stop: 0, color: cssVar("--bg-chart-area02") },
                        { stop: 1, color: "rgba(255, 255, 255, 0.3)" },
                      ],
                      true
                    );
              },
              borderColor: cssVar("--bg-chart-linearea02"),
              borderWidth: 1,
              pointRadius: 5,
              tension: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          /*
          layout: {
            padding: {
              top: 60,
            },
          },
          */
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: false,
            },
          },
          scales: {
            y: {
              grace: 4,
              afterBuildTicks: (scale) => {
                const maxValue = scale.chart.data.datasets
                  .flatMap((d) => d.data)
                  .filter((n) => typeof n === "number");

                const realMax = Math.max(...maxValue);

                // +50 후 백단위 올림
                const rawMax = realMax + 50;
                const targetMax = Math.ceil(rawMax / 100) * 100;

                const mid = Math.round(targetMax / 2);

                scale.max = targetMax;
                scale.min = 0;

                // tick 3개
                scale.ticks = [
                  { value: 0 },
                  { value: mid },
                  { value: targetMax },
                ];

                // 가운데 tick의 index 저장
                scale._midIndex = 1;
              },

              grid: {
                drawTicks: false,
                color: (context) => {
                  // 가운데 tick만 라인 보이게
                  return context.index === context.scale._midIndex
                    ? cssVar("--grid-border-dashed") // 보여줄 색상
                    : "rgba(0,0,0,0)"; // 안 보이게 (transparent)
                },
                lineWidth: (context) => {
                  // 가운데만 진하게, 나머지는 0
                  return context.index === context.scale._midIndex ? 1 : 0;
                },
              },

              border: { display: false },

              ticks: {
                padding: 10,
                color: cssVar("--chart-base"),
              },
            },
            x: {
              offset: true, // `offset: true` 유지
              grid: {
                drawTicks: false,
                lineWidth: 1,
                display: true,
                color: cssVar("--grid-border") || "#e0e0e0",
                drawOnChartArea: true, // 차트 영역에 그리기
                z: -1, // 또는 z-index를 낮춰서 뒤로 보내기
              },
              ticks: {
                color: function (context) {
                  //현재 월 체크
                  if (context.tick.label === "11") {
                    return cssVar("--chart-point");
                  }
                  return cssVar("--chart-base");
                },
                font: function (context) {
                  //현재 월 체크
                  if (context.tick.label === "11") {
                    return {
                      weight: "bold",
                      size: 18,
                    };
                  }
                  return {
                    weight: "normal",
                    size: 18,
                  };
                },
                padding: 12,
                callback: (value, index) => labels12[index] ?? "",
                sample: 0,
              },
              afterBuildTicks: (axis) => {
                // 각 틱의 위치를 0.5만큼 이동시켜 그리드 사이에 위치
                axis.ticks.forEach((tick) => {
                  // tick.value += 0.5;
                });
              },
              border: {
                display: true,
                dash: [3, 3],
                color: cssVar("--grid-border-dashed"),
                width: 1,
              },
            },
          },
        },
        plugins: [
          highlightXFactory("11"), //현재 월 값 전달
          hideNullPointsPlugin,
          createPointGradientPluginWithBorder(),
        ],
      });
    }
    createIndividualChart();
  })();
</script>
