<!doctype html>
<html lang="ko">
  <head>
    @@include("_include/_head.html")
  </head>
  <body>
    <div class="wrap">
      @@include("_include/_header.html")
      <!-- container -->
      <div class="container">
        <div class="main-contents">
          <div class="main-grid">
            <section class="card col">
              <div class="inner">
                <div class="card-header">
                  <h3>연간 총 판매 실적</h3>
                </div>
                <div class="card-body">
                  <div class="stat-row accrue">
                    <div class="label-box">
                      <span class="label">누적 판매수</span>
                      <span class="change-up">전월대비 <em>84</em></span>
                    </div>
                    <div>
                      <span class="big-num">475</span
                      ><span class="unit">copy</span>
                    </div>
                  </div>
                  <!-- // stat-row -->
                  <div class="stat-row">
                    <div class="label-box">
                      <span class="label">누적 판매액</span>
                      <span class="change">전월대비 <em>00</em></span>
                    </div>
                    <div>
                      <span class="big-num">0.0</span
                      ><span class="unit">억</span>
                    </div>
                  </div>
                  <!-- // stat-row -->
                  <div class="stat-row">
                    <div class="label-box">
                      <span class="label">목표 달성률</span>
                      <span class="change-up">전월대비 <em>1p</em></span>
                    </div>
                    <div>
                      <span class="big-num">95</span><span class="unit">%</span>
                    </div>
                  </div>
                  <!-- // stat-row -->
                </div>
                <!-- // card-body -->
              </div>
              <!-- // inner -->
              <div class="inner chart-wrap">
                <div class="chart-header">
                  <span class="badge-year">목표 500</span>
                  <div class="legend">
                    <span>
                      <span class="legend-dot mix-bar"></span>
                      월별 판매수
                    </span>
                    <span>
                      <span class="legend-dot mix-line"></span>
                      누적 판매수
                    </span>
                    <span class="unit">(단위:copy) </span>
                  </div>
                </div>
                <div class="chart-body">
                  <canvas id="yearly_chart"></canvas>
                </div>
              </div>

              <!-- // chart-warp -->
            </section>
            <section class="card individual">
              <div class="chart-wrap">
                <div class="card-header">
                  <h3>연간 개인별 판매 실적</h3>
                  <div class="legend">
                    <span>
                      <span class="legend-dot line-area01"></span>
                      권혁진 수석
                    </span>
                    <span>
                      <span class="legend-dot line-area02"></span>
                      염승호 수석
                    </span>
                    <span class="unit">(단위:copy) </span>
                  </div>
                </div>
                <div class="chart-body">
                  <div class="badge-box">
                    <span class="badge-individual01">목표 200</span>
                    <span class="badge-individual02">목표 300</span>
                  </div>
                  <canvas id="individual_chart"></canvas>
                </div>
              </div>
              <div class="card-body">
                <div class="person-box">
                  <div class="person-name">
                    <span>권혁진</span> <small>수석</small>
                  </div>
                  <div class="stat-row individual01">
                    <div class="label-box">
                      <span class="label">누적 판매수</span>
                      <div class="change-up">전월대비 <em>▲26</em></div>
                    </div>
                    <div>
                      <span class="big-num">188</span
                      ><span class="unit">copy</span>
                    </div>
                  </div>
                  <div class="stat-row">
                    <div class="label-box">
                      <span class="label">목표 달성률</span>
                      <div class="change-up">전월대비 <em>▲1</em></div>
                    </div>
                    <div>
                      <span class="big-num">94.0</span
                      ><span class="unit">%</span>
                    </div>
                  </div>
                </div>
                <div class="person-box">
                  <div class="person-name">
                    <span>염승호</span>
                    <small>수석</small>
                  </div>
                  <div class="stat-row individual02">
                    <div class="label-box">
                      <span class="label">누적 판매수</span>
                      <div class="change-up">전월대비 <em>▲73</em></div>
                    </div>
                    <div>
                      <span class="big-num">287</span
                      ><span class="unit">copy</span>
                    </div>
                  </div>
                  <div class="stat-row">
                    <div class="label-box">
                      <span class="label">목표 달성률</span>
                      <div class="change-up">전월대비 <em>▲1</em></div>
                    </div>
                    <div>
                      <span class="big-num">95.7</span
                      ><span class="unit">%</span>
                    </div>
                  </div>
                </div>
              </div>
            </section>
            <section class="card sales">
              <div class="card-header">
                <h3>연간 영업 판매 현황</h3>
              </div>
              <div class="card-body">
                <div class="stat-row sales">
                  <div class="label-box">
                    <span class="label">영업 업체수</span>
                    <span class="change-up">전월대비 <em>84</em></span>
                  </div>
                  <div>
                    <span class="big-num">168</span
                    ><span class="unit">copy</span>
                  </div>
                </div>
              </div>
              <div class="chart-wrap">
                <div class="chart-body">
                  <canvas id="industry_chart"></canvas>
                </div>
                <div class="chart-body">
                  <canvas id="institution_chart"></canvas>
                </div>
              </div>
            </section>
            <section class="card">
              <div class="inner">
                <div class="card-header">
                  <h3>8월 판매 실적</h3>
                </div>
                <div class="card-body">
                  <div class="stat-row month">
                    <div class="label-box">
                      <span class="label">당월 판매수</span>
                      <span class="change-down">전주대비 <em>70</em></span>
                    </div>
                    <div>
                      <span class="big-num">99</span
                      ><span class="unit">copy</span>
                    </div>
                  </div>

                  <div class="stat-row">
                    <div class="label-box">
                      <span class="label">당월 매출액</span>
                      <span class="change">전주대비 <em>00</em></span>
                    </div>
                    <div>
                      <span class="big-num">0.0</span
                      ><span class="unit">억</span>
                    </div>
                  </div>

                  <div class="stat-row">
                    <div class="label-box">
                      <span class="label">목표 달성률</span>
                      <span class="change-up">전주대비 <em>1p</em></span>
                    </div>
                    <div>
                      <span class="big-num">95</span><span class="unit">%</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="inner chart-wrap">
                <div class="chart-header">
                  <span class="badge-month">목표 125</span>
                  <div class="legend">
                    <span class="unit">(단위:copy) </span>
                  </div>
                </div>
                <div class="chart-body">
                  <canvas id="weekly_chart"></canvas>
                </div>
              </div>
            </section>
          </div>
          <!-- 주간 영업 계획 -->
          @@include("main_sub/weekly_plan.html")
          <!-- //주간 영업 계획 -->
        </div>
      </div>
    </div>

    <script>
      (() => {
        // ---------------------------
        // 유틸 / 공통
        // ---------------------------
        const charts = {}; // 차트 인스턴스 저장소

        const theme = {
          mixbar: [
            { stop: 0, color: cssVar("--bg-chart-mixbar01") },
            { stop: 0.3709, color: cssVar("--bg-chart-mixbar02") },
            { stop: 1, color: cssVar("--bg-chart-mixbar03") },
          ],
        };

        const labels12 = Array.from({ length: 12 }, (_, i) => String(i + 1));

        // ---------------------------
        // 플러그인 그룹
        // ---------------------------

        const valuePlugin = {
          id: "valuePlugin",
          afterDatasetsDraw(chart) {
            const { ctx } = chart;
            const isHorizontal = chart.config.options?.indexAxis === "y";
            ctx.save();
            ctx.font = "bold 13px Arial";
            ctx.textBaseline = "middle";
            chart.data.datasets.forEach((ds, i) => {
              if (ds.type === "line") return;
              const meta = chart.getDatasetMeta(i);
              meta.data.forEach((bar, j) => {
                const v = ds.data[j];
                if (v === null || v === undefined) return;
                if (isHorizontal) {
                  ctx.fillStyle = "#000";
                  ctx.textAlign = "left";
                  ctx.fillText(v, bar.x + 10, bar.y);
                } else {
                  ctx.fillStyle = "#fff";
                  ctx.textAlign = "center";
                  ctx.fillText(v, bar.x, bar.y + 10);
                }
              });
            });
            ctx.restore();
          },
        };

        const backgroundPlugin = {
          id: "backgroundBars",
          beforeDatasetsDraw(chart) {
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const metas = chart.getSortedVisibleDatasetMetas();
            ctx.save();
            metas.forEach((meta) => {
              meta.data.forEach((bar, index) => {
                if (!bar || bar.hidden) return;
                const dataset = chart.data.datasets[meta.index];
                const dataRange = dataset.data[index];
                if (!dataRange || dataRange === null) return;
                const barTop = bar.y - bar.height / 2;
                const barHeight = bar.height;
                const startWeek = Math.floor(dataRange[0]);
                const endWeek = Math.ceil(dataRange[1]);
                for (let i = startWeek; i < endWeek; i++) {
                  const xStart = xAxis.getPixelForValue(i);
                  const xEnd = xAxis.getPixelForValue(i + 1);
                  const width = xEnd - xStart;
                  ctx.fillStyle =
                    i % 2 === 0
                      ? "rgba(240,240,240,0.6)"
                      : "rgba(220,220,220,0.3)";
                  ctx.fillRect(xStart, barTop, width, barHeight);
                }
              });
            });
            ctx.restore();
          },
        };

        const dataLabelsPlugin = {
          id: "customDataLabels",
          afterDatasetsDraw(chart) {
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            ctx.save();
            ctx.font = "bold 14px sans-serif";
            ctx.fillStyle = "#fff";
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";
            chart.data.datasets.forEach((dataset) => {
              const metaIndex = chart.data.datasets.indexOf(dataset);
              const meta = chart.getDatasetMeta(metaIndex);
              if (!meta || meta.hidden) return;
              meta.data.forEach((bar, index) => {
                const displayValue = dataset.displayValues?.[index];
                if (displayValue == null) return;
                const dataRange = dataset.data[index];
                if (!dataRange) return;
                const endValue = dataRange[1];
                const textX = xAxis.getPixelForValue(endValue) - 10;
                ctx.fillText(displayValue, textX, bar.y);
              });
            });
            ctx.restore();
          },
        };

        // ---------------------------
        // 차트 생성 헬퍼
        // ---------------------------
        function createSafeChart(ctxOrId, config, name) {
          // ctxOrId : element id string or canvas element
          let el;
          if (typeof ctxOrId === "string") {
            el = document.getElementById(ctxOrId);
          } else {
            el = ctxOrId;
          }
          if (!el) {
            console.warn("[createSafeChart] canvas not found:", ctxOrId);
            return null;
          }
          // destroy existing
          if (charts[el.id]) {
            try {
              charts[el.id].destroy();
            } catch (e) {
              /* ignore */
            }
          }
          const c = new Chart(el, config);
          charts[el.id] = c;
          return c;
        }

        // ---------------------------
        // 전체 초기화 (모든 차트)
        // ---------------------------
        function initCharts() {
          // 복합 막대 + 라인
          createSafeChart("yearly_chart", {
            type: "bar",
            data: {
              labels: labels12,
              datasets: [
                {
                  type: "line",
                  order: 1,
                  data: [0, 0, 0, 0, 0, 0, 0, 0, 235, 376, 475, null],
                  borderColor: cssVar("--chart-mixline"),
                  borderWidth: 1,
                  pointRadius: 6,
                  tension: 0,
                  fill: false,
                },
                {
                  type: "bar",
                  order: 2,
                  data: [0, 0, 0, 0, 0, 0, 0, 0, 235, 141, 99, null],
                  backgroundColor: function (context) {
                    const chart = context.chart;
                    const { ctx, chartArea } = chart;

                    if (!chartArea) {
                      // 차트가 아직 초기화되지 않은 경우
                      return "#4CAE9B"; // 기본 색상
                    }

                    return safeGrad(ctx, chartArea, theme.mixbar);
                  },
                  borderRadius: { topLeft: 2, topRight: 2 },
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  display: false,
                  suggestedMax: 600, //목표 값
                },
                x: {
                  grid: {
                    drawTicks: false,
                  },
                  ticks: {
                    color: function (context) {
                      if (context.tick.label === "11") {
                        return cssVar("--chart-point");
                      }
                      return cssVar("--chart-base");
                    },
                    font: function (context) {
                      if (context.tick.label === "11") {
                        return {
                          weight: "bold",
                          size: 18,
                        };
                      }
                      return {
                        weight: "normal",
                        size: 18,
                      };
                    },
                    padding: 8,
                  },
                  border: {
                    display: true,
                    dash: [3, 3],
                    color: cssVar("--grid-border-dashed"),
                    width: 1,
                  },
                },
              },
            },
            plugins: [
              createMixedValuePlugin(12),
              createMixedPointGradientPlugin(),
              highlightXFactory("11"),
              hideNullPointsPlugin,
            ],
          });

          // 라인 + 영역
          createSafeChart("individual_chart", {
            type: "line",
            data: {
              labels: labels12,
              datasets: [
                {
                  label: "권혁진 수석",
                  data: [0, 0, 0, 0, 0, 0, 0, 0, 126, 36, 26, null],
                  fill: true,
                  backgroundColor: (ctx) => {
                    const a = ctx.chart.chartArea;
                    return !a
                      ? "rgba(145,128,80,0.3)"
                      : safeGrad(
                          ctx.chart.ctx,
                          a,
                          [
                            { stop: 0, color: "rgba(145,128,80,0.6)" },
                            { stop: 1, color: "rgba(145,128,80,0)" },
                          ],
                          true
                        );
                  },
                  borderColor: cssVar("--bg-chart-linearea01"),
                  borderWidth: 1,
                  pointRadius: 6,
                  tension: 0,
                },
                {
                  label: "염승호 수석 ",
                  data: [0, 0, 0, 0, 0, 0, 0, 0, 109, 105, 73, null],
                  fill: true,
                  backgroundColor: (ctx) => {
                    const a = ctx.chart.chartArea;
                    return !a
                      ? "rgba(36,148,115,0.3)"
                      : safeGrad(
                          ctx.chart.ctx,
                          a,
                          [
                            { stop: 0, color: "rgba(36,148,115,0.6)" },
                            { stop: 1, color: "rgba(36,148,115,0)" },
                          ],
                          true
                        );
                  },
                  borderColor: cssVar("--bg-chart-linearea02"),
                  borderWidth: 1,
                  pointRadius: 6,
                  tension: 0,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  display: false,
                  suggestedMax: 350, //목표 값
                },
                x: {
                  offset: true,
                  grid: {
                    drawTicks: false,
                    display: true, // 그리드 라인 표시
                    color: cssVar("--grid-border") || "#e0e0e0",
                  },
                  ticks: {
                    color: function (context) {
                      if (context.tick.label === "11") {
                        return cssVar("--chart-point");
                      }
                      return cssVar("--chart-base");
                    },
                    font: function (context) {
                      if (context.tick.label === "11") {
                        return {
                          weight: "bold",
                          size: 18,
                        };
                      }
                      return {
                        weight: "normal",
                        size: 18,
                      };
                    },
                    padding: 8,
                  },
                  border: {
                    display: true,
                    dash: [3, 3],
                    color: cssVar("--grid-border-dashed"),
                    width: 1,
                  },
                },
              },
            },
            plugins: [
              highlightXFactory("11"),
              createPointGradientPluginWithBorder(),
              hideNullPointsPlugin,
            ],
          });

          createSafeChart("industry_chart", {
            type: "doughnut",
            data: {
              labels: ["설계", "제작", "감리", "시공", "기타"],
              datasets: [
                {
                  data: [68, 19, 11, 11, 45],
                  backgroundColor: [
                    "#D08A5D",
                    "#8F4818",
                    "#5F2F0E",
                    "#45220A",
                    "#B66532",
                  ],
                  borderWidth: 2,
                  borderColor: "#fff",
                  rotation: 125,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "55%",
              layout: {
                padding: { top: 60, bottom: 60, left: 100, right: 100 },
              },
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
              },
            },
            plugins: [
              totalCenterPluginFactory("산업/업종별"),
              externalLabelPlugin,
            ],
          });
          createSafeChart("institution_chart", {
            type: "doughnut",
            data: {
              labels: ["일반", "교육기관", "공공기관", "기타"],
              datasets: [
                {
                  data: [138, 14, 12, 4],
                  backgroundColor: ["#C4964B", "#885D1A", "#5C3E0F", "#3C2500"],
                  borderWidth: 2,
                  borderColor: "#fff",
                  rotation: 125,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "55%",
              layout: {
                padding: { top: 60, bottom: 60, left: 100, right: 100 },
              },
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
              },
            },
            plugins: [totalCenterPluginFactory("기관별"), externalLabelPlugin],
          });

          const cumulative = [27, 71, 1, 0, 0];
          const goal = 125;
          const total = cumulative.reduce((sum, val) => sum + val, 0);
          const remaining = Math.max(0, goal - total);

          createSafeChart("weekly_chart", {
            type: "doughnut",
            data: {
              labels: [
                "1주차",
                "2주차",
                "3주차",
                "4주차",
                "5주차",
                "남은 목표",
              ],
              datasets: [
                {
                  data: [...cumulative, remaining],
                  backgroundColor: [
                    "#4A9B7F",
                    "#5FAA8D",
                    "#74B99B",
                    "#89C8A9",
                    "#9ED7B7",
                    "#E8E8E8",
                  ],
                  borderWidth: 2,
                  borderColor: "#fff",
                  circumference: 180,
                  rotation: 270,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: {
                    font: { size: 12 },
                    padding: 15,
                    generateLabels: function (chart) {
                      const data = chart.data;
                      return data.labels
                        .map((label, i) => {
                          if (i === 5) return null; // "남은 목표" 제외
                          return {
                            text: `${label}: ${data.datasets[0].data[i]}`,
                            fillStyle: data.datasets[0].backgroundColor[i],
                            hidden: false,
                            index: i,
                          };
                        })
                        .filter((item) => item !== null);
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || "";
                      const value = context.parsed;
                      if (context.dataIndex === 5) {
                        return `남은 목표: ${value}`;
                      }
                      return `${label}: ${value}`;
                    },
                  },
                },
              },
              cutout: "70%",
              layout: {
                padding: { top: 20, bottom: 20, left: 40, right: 40 },
              },
            },
            plugins: [gaugeValuePlugin],
          });
        } // initCharts 끝

        // ---------------------------
        // 리사이즈 데바운스 및 리프레시
        // ---------------------------
        function debounce(fn, wait = 120) {
          let t;
          return function (...args) {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), wait);
          };
        }

        const handleResize = debounce(() => {
          Object.values(charts).forEach((c) => {
            try {
              c.resize();
              c.update();
            } catch (e) {
              /* ignore */
            }
          });
        }, 120);

        window.addEventListener("resize", handleResize);

        // ---------------------------
        // 초기 실행
        // ---------------------------
        // DOM ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initCharts);
        } else {
          initCharts();
        }

        // 외부에서 재초기화 가능하게 노출
        window.__CHARTS = {
          charts,
          init: initCharts,
          destroyAll: () => {
            Object.keys(charts).forEach((k) => {
              try {
                charts[k].destroy();
              } catch (e) {}
              delete charts[k];
            });
          },
        };
      })();
    </script>
  </body>
</html>
